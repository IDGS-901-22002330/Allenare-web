# ==========================================
# PIPELINE CI/CD para Node.js + React (Vite) -> Deploy a Azure App Service
# ==========================================

trigger:
  branches:
    include:
      - dev
      - main

pool:
  vmImage: ubuntu-latest

# NO definir NODE_ENV globalmente
# variables:
#  NODE_ENV: production

stages:
# ======================
# 1️⃣ BUILD STAGE
# ======================
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20'

    - script: |
        node -v
        npm -v
        echo "--- Cleaning npm cache and node_modules ---"
        npm cache clean --force
        rm -rf node_modules
        echo "--- Running npm ci with legacy peer deps ---"
        npm ci --legacy-peer-deps
        echo "--- npm ci finished ---"
        echo "--- Running build ---"
        npx vite build
      displayName: 'Clean, Install Dependencies and Build App'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'dist'
        ArtifactName: 'drop'
      displayName: 'Publish Build Artifacts'

# ======================
# 2️⃣ TEST STAGE
# ======================
- stage: Test
  dependsOn: Build
  displayName: 'Test Stage'
  jobs:
  - job: TestJob
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20 (for Test)'

    - script: |
        echo "--- Installing dependencies for tests ---"
        npm ci
        echo "--- Running tests ---"
        npm test
      displayName: 'Install Deps & Run Tests'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results JUnit'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/junit.xml'
        failTaskOnFailedTests: true


